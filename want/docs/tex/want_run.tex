%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  Copyright (C) 2005 WanT group                         %
%  This file is distributed under the terms of the       %
%  GNU General Public License.                           %
%  See the file `License'  in the root directory of      %
%  the present distribution,                             %
%  or http://www.gnu.org/copyleft/gpl.txt                %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\thispagestyle{empty}
\section{How to run \WANT\ : a step by step description}\label{section:run}

\noindent \underline {NOTE}: At present the \WANT\ code is
implemented to work as post processing of DFT 
calculations done using the \PWSCF package (\PWSCFURL); we
will refer to that code in the following.\\

\noindent Following the theoretical description of
Section~\ref{section:intro}, the evaluation of transport
properties requires three separate steps:

\begin{enumerate}
\item Calculation of DFT electronic structure
\item Calculation of maximally-localized Wannier functions
\item Calculation of quantum conductance
\end{enumerate}

\noindent \underline{IMPORTANT}: For a correct results, the
following steps \textbf{MUST} be done in the reported order.

\subsection{Preliminary Steps: DFT
Calculations}\label{subsection:run_dft}
\renewcommand{\theenumi}{\roman{enumi}}
\renewcommand{\labelenumi}{\theenumi)}
\begin{enumerate}
%
\item Self-consistent calculation using the \PWSCF code.\\
      \noindent For the description of the input and for further details see the \PWSCF
      manual.
      %
\item Bandstucture calculation.\\
      \noindent  Starting from the self-consistent charge
      calculated in point $(1)$, we calculate the Bloch functions for a
      {\bf REGULAR {\bf k}-point grid in the COMPLETE Brillouin Zone}; Gamma point
      must be included. Reduction of \textbf{k}-points due to time-reversal 
      symmetry is not (yet) allowed. The complete list of 
      \textbf{k}-points should be specified in the {\tt K\_POINTS} card. 
      The simple program
      {\tt kgrid.f90} in {\tt \$TOPDIR/utility }can be used to generate non-symmetrized 
      Monkhorst-Pack grids.
      %
\item From \PWSCF to the Wannier code.\\
      \noindent Use the post processing
      {\tt pw\_export.x} (distributed in the \PWSCF package 
      %
      \footnote{The export utility is already distributed in the 
      Qantum-Espresso v3.0, but a patch to include it also in versions v2.1.x is
      available at \WANTURL{} or \PWSCFURL{}.} 
      ),
      %
      to extract the input data necessary for the following Wannier
      calculations
      from \PWSCF output datafile. Data will be stored in the
      newly-created directory {\tt \$prefix.export/}.
\end{enumerate}

\noindent \underline{NOTE}: Steeps (i-iii) should be be run, using the
parallel version of the code, paying attention to use the same
number of processors. From this point to the end, instead, the
code is scalar.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection {Calculation of maximally-localized Wannier
functions}\label{subsection:run_wannier}

Following the list of input parameters as in
Section~\ref{section:input} (also reported in the {\tt README.input} file
in {\tt \$TOPDIR/docs/}) and the examples in directory {\tt \$TOPDIR/tests/}, 
create your own input file, that will be used for the following two steps (a-b).
\renewcommand{\theenumi}{\alph{enumi}}
\renewcommand{\labelenumi}{\theenumi)}
%
%
\begin{enumerate}
\item {\tt disentangle.x}: Starting from the data stored at level (iii), 
      the code selects the working energy window. From there
      it will extract a selected number ($N$) of WFs to setup the 
      Hilbert subspace for Wannier localization.
      For each \textbf{k}-point, the energy window {\bf must}
      contain a number of bands not lower than $N$.
      It is possible to use an inner window (inside the working one) to
      treat frozen-states, for details see Ref.~\cite{ivo2}:
      these frozen Bloch-states will be kept as they are in the Wannier subspace.
      % 
      Trial Wannier centers are not mandatory in this step (depending
      on the {\tt subspace\_init} flag).
      The code produces a standard output with the main results,
      and two internal files: {\tt \$prefix\_\$postfix.ovp} and
      {\tt \$prefix\_\$postfix.space} . The former keeps trace of the 
      computed overlap and projection integrals (to be re-used in further 
      or restarted calculations) while the latter describe the wannier optimal 
      subspace.
      %

\item {\tt wannier.x}: the code reads the same input of {\tt disentangle.x} and
      performs the localization
      procedure leading to the maximally localized WFs. 
      The optimal unitary matrices $U(\mathbf{k})$ governing the transformation between
      Bloch and Wannier states are obtained.
      In this step different trial centers can be used, but it is a standard procedure
      to keep those used in the {\tt disentangle.x} run.
      {\tt wannier.x} produces a standard output with describing the iterative
      path to the optimally localized WFs. 
      The code also writes two internal data-files: {\tt \$prefix\_\$postfix.wan}
      containing the $U(\mathbf{k})$ and {\tt \$prefix\_\$postfix.ham} with the 
      hamiltonian matrix elements on the Wannier basis.
      %
\end{enumerate}
%
%

\noindent
Further physical information may be obtained as external
post-processing of the Wfs calculation. They are not necessary for
the transport calculation, but they may be useful for a
better understanding of the intrinsic electronic properties of the
system. These codes require a separate input, to be generated
following Sec.~\ref{section:input} or the file
{\tt \$TOPDIR/docs/README.input} .

%
%
\begin{itemize}
%
\item {\tt bands.x}: the code computes the interpolated band-structure
      of the system along selected direction in the Brillouin Zone.
      The comparison with indipendently calculated DFT eigenvalues is
      a nice test to check the localization of the obtained WFs.
      When they are well behaved ({\it i.e.} localized), only few $\mathbf{R}$ lattice 
      vectors are required to described the Hamiltonian on the Wannier basis 
      [$H_{ij}(\mathbf{R})$]
      Starting with a small set of $\mathbf{k}$ in the DFT calculation
      we obtain the Hamiltonian on the related (small) set of lattice vectors. 
      When WFs are well localized 
      the Hamiltonian is fully described on this set of $\mathbf{R}$ and we can
      diagonalize it for an arbitrary large set of $\mathbf{k}$ points 
      (as a post-processing of the Wannier code). This is the
      interpolation of the band structure using WFs. If they are not localized
      we are essentially throuwing away some non-negligible matrix elements 
      in the Hamiltonian representation, and the bands
      are not accurate. Typical unphysical oscillations appears in these cases.
      % 
      The code produces three files {\tt \$prefix\_\$postfix\_dftband.dat,
      \$prefix\_\$postfix\_wanband.dat} and {\tt \$prefix\_\$postfix\_intband.dat}
      which cab be used for a direct visualization.
      %

\item {\tt plot.x}: this is an utility to plot WFs in real space.
      The plotting region can be tuned and a genereic number of WFs can be
      handled in a single run.
      The real or immaginary parts of the WFs as well as their squared moduli are
      allowed fields to be plotted.
      The code produces plot files in various formats (txt, gaussian cube, xsf, plt) 
      allowing the use of standard open source visualization-packages
      such as gOpenMol or xCrysDen. Output files are labelled as 
      {\tt \$prefix\_\$postfix\_WF\$type\_\$num.\$fmt}, where {\tt \$type} can be
      {\tt R, I, M} according to the plotted field (real or immaginary part, squared 
      modulus), {\tt \$num} is the index of the chosen WF and {\tt \$fmt} is the
      output format. If needed, an auxiliary file with the atomic structure 
      in the {\tt xyz} format is also produced.
      %
\item {\tt blc2wan.x}: transforms a generic (eventually dynamic) operator 
      given on the Bloch eigenstates basis $A_{mn}(\mathbf{k}) =
      \langle \psi_{m\mathbf{k}} |\, \widehat{A}(\omega) \,| 
      \psi_{n\mathbf{k}} \rangle$ to the WFs representation. 
      Using the unitary matrices $U(\mathbf{k})$ calculated during the Wannier localization
      (b) and the definition of the Wannier subspace in terms of the Bloch eigenstates
      (a), $\widehat{A}(\omega)$ is described in terms of the matrix elements
      $A_{ij}(\mathbf{R}) = \langle w_{i\mathbf{0}} |\, \widehat{A}(\omega) \,| 
      w_{j\mathbf{R}} \rangle$ .
\end{itemize}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection {Calculation of electronic transport}
\label{subsection:transport}

Using the hamiltonian matrices calculated in step (b) we can
calculate both the {\em bulk} and the {\em two-terminal} transmittance.
Input file may be generated following Sec.~\ref{section:input}
or the file {\tt README.input} in {\tt \$TOPDIR/docs}. The main result of the 
calculation is the quantum transmittance across the conductor region
which is written on file {\tt \$SCRATCH/cond.dat}. Conductance is given
in $2e^2/h$ units. Calculations are performed using the Fisher-Lee formula
according to Sec.~\ref{subsec:tran}.
As an auxiliary piece of information, the density of states (DOS) projected on
the conductor is also writte in {\tt \$SCRATCH/dos.dat}.
This DOS is computed as the trace of the conductor Green's function
$ N(E) = -(1/\pi)\, \text{Im} \, \text{Tr}\, G_C(E)$.

Except the special case of the bulk transmittance (see below), the systems one is
interested in are generally not periodic along the transport direction. This does not
in principle avoid a 2D periodicity in the orthogonal plane. The use of 
2D mesh of $\mathbf{k}$-points in this context is implemented in the present 
version of the code.  \\

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%
\begin{figure}
   \centering
   \includegraphics[clip,width=0.6\textwidth]{acb}
   \caption{Schematic definitions for Hamiltonian block matrices used in 
	    transport calculations. \label{fig:matrix_naming}}
\end{figure}
%
%
\noindent 
Before discussing in more ditail the actual calculations performed by
the transport code, we precisely define the adopted convention for the
names of the real-space ({\i.e.} WF) Hamiltonian blocks.  
Given a conductor (C) connected to left (L) and right (R) leads, containing
respectively $N_C$, $N_L$ and $N_R$ WFs, 
we define the following matrices (see Fig.~\ref{fig:matrix_naming}): \\

%
%
\begin{tabular}{lllll}
\texttt{H00\_L} &=& $N_L\times N_L$ on-site hamiltonian
of the leads L & (from L-bulk calc.)\\
\texttt{H01\_L} &=& $N_L\times N_L$ hopping hamiltonian
of the leads L & (from L-bulk calc.) \\
\texttt{H00\_R} &=& $N_R\times N_R$ on site hamiltonian
of the leads R & (from R-bulk calc.) \\
\texttt{H01\_R} &=& $N_R\times N_R$ hopping hamiltonian
of the leads R & (from R-bulk calc.) \\
\texttt{H00\_C} &=& $N_C\times N_C$ on site hamiltonian
of the conductor C & (from C-supercell calc.) \\
\texttt{H\_LC}  &=& $N_L\times N_C$ coupling
between lead L and conductor C & (from C-supercell calc.) \\
\texttt{H\_CR}  &=& $N_C\times N_R$ coupling
between conductor C and lead R & (from C-supercell calc.)
%
%
\end{tabular}
%
%
\\

\noindent
In the general case we need to compute the electronic structure and
WFs for three different regions L, C, R.
This picture may be simplified as we will discuss below.


\noindent \underline{NOTES}: (i) The definition of the coupling
matrices HCI\_ {\bf MUST BE DONE CAREFULLY case by case},
depending on the particular system definition. (ii) In order to
match the hamiltonian matrices at the boundary, it is necessary to
check that the diagonal elements of the H00 matrices were aligned.
If not, a rigid shift may be applied. \\


\noindent {\tt conductor.x} calculates both the {\em bulk} and the
{\em two-terminal} transmittance for the systems.
%
%
\begin{itemize}
\item {\bf bulk} transmittance: the conductor and the leads are
      the same and the whole system is periodic.
      According to the 
      We only need hamiltonian matrices are needed: that belonging to the
      reference cell ( 0 0 0 three last number in the first line, see
      step (b) ) and  that  belonging to the first
      cell in the direction along which we calculate the transport ( e.g.
      1 0 0 in the first line, in order to calculate the transport along
      x-dirction).

\item In the case of {\bf two-terminal} transmittance we need, in principle, 
      three sets of
      calculations (two only if the leads are of the same material): bulk
      calculations for the two infinite leads and a supercell calculation
      for the conductor and the contacts (see PRB 69, 035108 (2004)).
      The labels for the hamiltonian matrices used in the input of conductor.x 
      refer to the scheme below.
\end{itemize}
%
%
